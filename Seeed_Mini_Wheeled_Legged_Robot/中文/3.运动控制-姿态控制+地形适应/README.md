## 第3章 姿态控制+地形适应

### 运动学逆解

逆运动学可以根据轮足机器人脚的期望末端位置推算出需要的舵机角度，从而修改腿部状态，进而实现不同的姿态控制。

* **运动学逆解**：已知期望足端坐标 $B(x, y)$，求关节转角 $\alpha, \beta$。

  * *意义*：实现从**想让脚去哪**到**电机该转多少度**的精确转换。

![](<images/轮足机器人 运动控制 学习教程-image-15.png>)

**关节角&#x20;**$\alpha$**&#x20;的推导过程**

目标：通过已知点 $B(x, y)$ 求解左侧电机角度 $\alpha$。

1. 建立基础方程

根据连杆几何关系，足端 $B$ 的坐标可写为：

* $x = L_1 \cos\alpha + L_2 \cos\theta$

* $y = L_1 \sin\alpha + L_2 \sin\theta$

2. 消去中间变量 $\theta$&#x20;

为了消除不确定量 $\theta$，将式子变形为：$(x - L_1 \cos\alpha)^2 + (y - L_1 \sin\alpha)^2 = (L_2 \cos\theta)^2 + (L_2 \sin\theta)^2$展开并利用 $\sin^2\theta + \cos^2\theta = 1$ 整理得：

$$x^2 + y^2 - 2xL_1 \cos\alpha - 2yL_1 \sin\alpha + L_1^2 = L_2^2$$

3. 构建标准三角方程

将上式整理成 $a \cos\alpha + b \sin\alpha = c$ 的形式，其中：

* $a = 2xL_1$

* $b = 2yL_1$

* $c = x^2 + y^2 + L_1^2 - L_2^2$

4. 万能公式代换与求解

引入 $\tan(\frac{\alpha}{2})$，将方程转化为关于 $X = \tan(\frac{\alpha}{2})$ 的一元二次方程：

$$(-a-c)X^2 + 2bX + (a-c) = 0$$

利用求根公式解得 $X$，最终得到 $\alpha$：

$$\alpha = 2 \arctan\left(\frac{b \pm \sqrt{a^2 + b^2 - c^2}}{a + c}\right)$$

**关节角&#x20;**$\beta$**&#x20;的推导过程**

目标：通过已知点 $B(x, y)$ 求解右侧电机角度 $\beta$。

1. 向量加法建立关系

通过右侧连杆 $L_4$（转角 $\beta$）和 $L_5$（水平偏移）确定点 $C$ 的坐标：

$$\vec{OC} = \vec{OD} + \vec{DC} = (L_5 + L_4 \cos\beta, L_4 \sin\beta)$$

2. 建立 $\beta$ 的标准方程

同理利用 $B$ 点坐标和杆长 $L_3$，消除中间变量后得到：

$$d \cos\beta + e \sin\beta = f$$

其中：

* $d = 2(x - L_5)L_4$

* $e = 2yL_4$

* $f = (x - L_5)^2 + L_4^2 + y^2 - L_3^2$

3. 最终公式

仿照 $\alpha$ 的求解步骤，使用万能公式解得：

$$\beta = 2 \arctan\left(\frac{e \pm \sqrt{d^2 + e^2 - f^2}}{d + f}\right)$$

> &#x20;lesson6\_HeightCtrl / src / main.cpp&#x20;
>
> 通过代码实现数学解算是一个复杂的过程，演示代码会有些不一样和省略的地方，但是最后得出的变量是正确的，需学习者耐心理解。

![](<images/轮足机器人 运动控制 学习教程-image-16.png>)

![](<images/轮足机器人 运动控制 学习教程-image-17.png>)

### 柔顺控制

为了避免电机动作生硬，需要实现足端坐标的连续、密集输出。

**参数设定 $X=0$**

在自平衡状态下，通常设定 $X=0$，确保腿部只在垂直方向（$Y$轴）运动，简化控制模型。

**密集点生成公式 ($Kp_Y$)**

程序不直接跳变到目标高度，而是通过以下公式迭代：

$$Y = Y + Kp\_Y \times (Y_{demand} - Y)$$

* **$Y_{demand}$**：期望的目标腿高。

* **$Kp\_Y$ 的影响**：

  * **值越小**：生成的 $B(x, y)$ 坐标点越密集，舵机转动越丝滑。

  * **值越大**：动作越快，但可能产生冲击。

![](<images/轮足机器人 运动控制 学习教程-image-18.png>)

**实现流程**

1. **输入**：设定目标腿高 $Y_{demand}$。

2. **规划**：通过 $Kp\_Y$ 循环生成密集的中间坐标点。

3. **逆解**：将每个点带入逆运动学公式，实时计算出对应的 $\alpha$ 和 $\beta$。

4. **执行**：将计算出的角度连续发送给舵机，实现流畅的蹲起或平衡动作。



### 姿态控制

#### 1. 高度控制

参考**柔顺控制**，只需要修改坐标点$y$，保持坐标点$x=0$即可，带入逆运动学公式，计算出对应的 $\alpha$ 和 $\beta$并输出给舵机。

#### 2. 滚转姿态控制

滚转控制本质上是让机器人左右倾斜。对于轮足机器人，这不需要额外的驱动，而是通过改变左右两条腿的**期望高度**（$L\_Height\_Demand$，$R\_Height\_Demand$）来实现。

**滚转角与高度差的转换**：以机身中心为转轴，当它逆时针旋转一个角度 $\phi$ 时，左端下降，右端上升。

**计算高度差公式**：$E_H = \frac{I}{2} \cdot \sin(\phi)$

* $I$：机器人机身的宽度。

* $\phi$：遥控器给出的期望滚转角度。

**左右腿高度分配**：

* **左腿期望高度**：$L\_Height\_Demand = Remoter\_Input + E_H$

* **右腿期望高度**：$R\_Height\_Demand = Remoter\_Input - E_H$

![](<images/轮足机器人 运动控制 学习教程-image-19.png>)

> &#x20;lesson7\_RollCtrl / src / main.cpp&#x20;
>
> 如代码所示，通过遥控器数据获取期望高度和滚转角度，先用柔顺控制解算当前控制高度，再求解高度差来计算左右腿的期望高度。

![](<images/轮足机器人 运动控制 学习教程-image-20.png>)



### 复杂地形自适应

复杂地形自适应是指当机器人置于斜坡或不平整表面时，其身体会发生横向倾斜。为了保持水平稳定，机器人必须通过调整**腿部长度**来抵消这种倾斜。

![](<images/轮足机器人 运动控制 学习教程-image-21.png>)



#### 自加量补偿算法

$$stab\_roll = stab\_roll + Kp\_roll \times (0 - mpu\_roll)$$

* **stab\_roll**：滚转姿态补偿角。

* **Kp\_roll**：转换系数（比例增益），用于控制机器人对地形变化的**恢复速度**。

* **0 - mpu\_roll**：目标角度（0度）与陀螺仪观测到的实际角度之差。

![](<images/轮足机器人 运动控制 学习教程-image-22.png>)



#### 执行过程分析

机器人在运行时，程序是一直处于循环之中的。该算法通过**极高频率的循环**，一点一点地增加高度，直到平衡为止。

**第一阶段：失衡检测**

* **初始状态**：当机器人进入斜坡，陀螺仪观测到的滚转角 $mpu\_roll$ 不再为 0 。

* **误差计算**：公式中的 $(0 - mpu\_roll)$ 代表了**目标水平姿态**与**实际倾斜姿态**之间的误差。

**第二阶段：自加补偿量的生成**

* **动态调整**：如果地形越不平整（$mpu\_roll$ 越大），计算出的误差就越大。

* **系数转换**：该误差乘以 $Kp\_roll$（转换系数）后，形成一个**自加量**。

* **累加效应**：由于程序处于极高频率的循环中，这个自加量会不断叠加到原先的 $stab\_roll$ 上。这意味着变量$stab\_roll$ 会持续增加，产生一个越来越大的**补偿角度**。

![](<images/轮足机器人 运动控制 学习教程-image-23.png>)

**第三阶段：腿部动作反馈**

* **指令下达**：生成的 $stab\_roll$ 被实时输入到**滚转姿态控制程序**中。

* **物理补偿**：控制器根据该值计算并**调整左右腿部的伸缩长度**。

* **姿态修正**：随着腿部动作，机器人的机身开始向水平方向回正。

**第四阶段：达到动态平衡**

* **趋近零值**：当机身接近水平（$mpu\_roll$ 趋近 0）时，自加项 $Kp\_roll \times (0 - mpu\_roll)$ 也随之趋近于 0 。

* **停止自加**：一旦 $mpu\_roll$ **等于 0**，公式中的**增量消失**，$stab\_roll$ **停止增长**，维持在当前能使机器人平衡的**固定值**上。

* **自稳完成**：此时，机器人成功在斜坡上维持了水平姿态，完成了滚转姿态自稳定。

![](<images/轮足机器人 运动控制 学习教程-image-24.png>)

> &#x20;lesson8\_adaptive / src / main.cpp&#x20;
>
> 如代码所示，本质是将滚转控制的高度差E\_H替换成滚转姿态补偿角stab\_roll。

![](<images/轮足机器人 运动控制 学习教程-image-25.png>)



